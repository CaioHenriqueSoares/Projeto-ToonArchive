<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Leitor de Cap√≠tulo - Toon Archive</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body {
      background-color: #0A1014;
      color: #eee;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      text-align: center;
      user-select: none;
    }

    main {
      padding: 30px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 25px;
    }

    h2 {
      color: #fff;
      display: flex;
      align-items: baseline;
      justify-content: center;
      gap: 10px;
    }

    .chapter-number {
      color: #9d4edd;
      font-size: 18px;
      font-weight: bold;
    }

    .chapter-title {
      color: #fff;
      font-size: 20px;
      font-weight: bold;
    }

    .pagina {
      max-width: 900px;
      width: 100%;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
      cursor: pointer;
      transition: transform 0.2s;
    }

    .pagina:hover { transform: scale(1.01); }

    .navegacao {
      color: #bbb;
      margin-top: 10px;
    }

    /* === COMENT√ÅRIOS === */
    .comentarios {
      background-color: #1B1C22;
      border-radius: 10px;
      padding: 20px;
      width: 80%;
      max-width: 800px;
      text-align: left;
      box-shadow: 0 0 10px rgba(0,0,0,0.6);
    }

    .comentarios h3 {
      color: #fff;
      margin-bottom: 10px;
      border-bottom: 1px solid #333;
      padding-bottom: 5px;
    }

    .comentario-item {
      background-color: #16161c;
      padding: 14px 16px 10px 16px;
      margin-bottom: 16px;
      border-radius: 10px;
      border: 1px solid #252525;
      position: relative;
      transition: all .2s ease-in-out;
    }

    .comentario-item:hover {
      background-color: #1e1e24;
    }

    .comentario-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .comentario-header .autor {
      font-weight: bold;
      color: #b266ff;
      font-size: 15px;
    }

    .comentario-acoes {
      position: absolute;
      top: 8px;
      right: 8px;
      display: flex;
      gap: 6px;
    }

    .comentario-acoes button {
      background: none;
      border: none;
      color: #aaa;
      font-size: 13px;
      cursor: pointer;
      padding: 2px;
      transition: color .2s, transform .2s;
    }

    .comentario-acoes button:hover {
      color: #b266ff;
      transform: scale(1.1);
    }

    .comentario-texto {
      margin-top: 12px;
      margin-bottom: 8px;
      font-size: 15px;
      color: #ddd;
      line-height: 1.5;
    }

    .comentario-data {
      font-size: 13px;
      color: #aaa;
      margin-top: 8px;
      display: block;
      text-align: right;
    }

    /* === EDI√á√ÉO INLINE === */
    .comentario-editar-area {
      width: 100%;
      background-color: #111;
      color: #fff;
      border: 1px solid #333;
      border-radius: 6px;
      padding: 8px;
      margin-bottom: 8px;
      font-size: 14px;
      resize: vertical;
    }

    .comentario-salvar-btn,
    .comentario-cancelar-btn {
      background-color: #9d4edd;
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      margin-right: 6px;
      transition: background .3s;
    }

    .comentario-cancelar-btn {
      background-color: #333;
    }

    .comentario-salvar-btn:hover { background-color: #b266ff; }
    .comentario-cancelar-btn:hover { background-color: #555; }

    textarea {
      width: 100%;
      height: 80px;
      border-radius: 6px;
      border: none;
      padding: 10px;
      margin-top: 10px;
      background-color: #111;
      color: white;
      resize: none;
      font-size: 14px;
    }

    button {
      background-color: #9d4edd;
      border: none;
      padding: 10px 15px;
      border-radius: 6px;
      color: white;
      cursor: pointer;
      margin-top: 10px;
      font-weight: bold;
      transition: background .3s;
      width: 100%;
    }

    button:hover {
      background-color: #b266ff;
    }

    footer {
      text-align: center;
      margin-top: 40px;
      padding: 15px;
      font-size: 14px;
      color: #888;
    }
  </style>
</head>
<body>
  <header>
    <a href="Html-toonarchive.html"><img src="assets/logo.png" alt="Toon Archive"></a>
  </header>

  <main>
    <h2 id="tituloCapitulo">
      <span class="chapter-number"></span>
      <span class="chapter-title">Carregando cap√≠tulo...</span>
    </h2>

    <div id="conteudoCapitulo"><p>Carregando p√°ginas...</p></div>
    <p class="navegacao" id="paginaAtual"></p>

    <!-- SE√á√ÉO DE COMENT√ÅRIOS -->
    <div class="comentarios">
      <h3>Coment√°rios</h3>
      <div id="comentariosContainer"><p>Carregando coment√°rios...</p></div>
      <form id="comentarioForm">
        <textarea id="comentarioTexto" placeholder="Escreva um coment√°rio..." required></textarea>
        <button type="submit">Enviar</button>
      </form>
    </div>
  </main>

  <footer>¬© 2025 Toon Archive - Todos os direitos reservados.</footer>

  <script>
    const API = "http://localhost:8080";

    async function carregarCapitulo() {
      const params = new URLSearchParams(window.location.search);
      const id = params.get("id");
      if (!id) return;

      const resposta = await fetch(`${API}/capitulos/${id}`);
      const capitulo = await resposta.json();

      document.querySelector(".chapter-number").textContent = `Cap√≠tulo ${capitulo.numero} -`;
      document.querySelector(".chapter-title").textContent = capitulo.tituloCapitulo;

      const paginas = (capitulo.paginas || "").split(";").filter(p => p.trim() !== "");
      const conteudo = document.getElementById("conteudoCapitulo");
      const indicador = document.getElementById("paginaAtual");

      if (paginas.length === 0) {
        conteudo.innerHTML = "<p>Este cap√≠tulo n√£o possui p√°ginas cadastradas.</p>";
        return;
      }

      let indice = 0;
      const img = document.createElement("img");
      img.className = "pagina";
      conteudo.innerHTML = "";
      conteudo.appendChild(img);

      function atualizarPagina() {
        img.src = `${API}${paginas[indice]}`;
        indicador.textContent = `P√°gina ${indice + 1} de ${paginas.length}`;
      }

      img.addEventListener("click", e => {
        const meio = img.clientWidth / 2;
        if (e.offsetX > meio && indice < paginas.length - 1) indice++;
        else if (e.offsetX < meio && indice > 0) indice--;
        atualizarPagina();
      });

      document.addEventListener("keydown", e => {
        if (e.key === "ArrowRight" && indice < paginas.length - 1) indice++;
        else if (e.key === "ArrowLeft" && indice > 0) indice--;
        atualizarPagina();
      });

      atualizarPagina();
      carregarComentarios(id);
    }

    async function carregarComentarios(capituloId) {
      const container = document.getElementById("comentariosContainer");
      const resp = await fetch(`${API}/comentarios/capitulo/${capituloId}`);
      const comentarios = await resp.json();
      const apelido = localStorage.getItem("apelido");

      if (!comentarios.length) {
        container.innerHTML = "<p>Nenhum coment√°rio ainda.</p>";
        return;
      }

      container.innerHTML = comentarios.map(c => `
        <div class="comentario-item" data-id="${c.id}">
          <div class="comentario-header">
            <span class="autor">${c.autor}</span>
            ${apelido === c.autor || localStorage.getItem("tipo") === "admin" ? `
  <div class="comentario-acoes">
    <button title="Editar">‚úèÔ∏è</button>
    <button title="Excluir">üóëÔ∏è</button>
  </div>` : ""}

          </div>
          <div class="comentario-texto">${c.texto}</div>
          <span class="comentario-data">${new Date(c.dataHora).toLocaleString()}</span>
        </div>`).join("");

      // === EDI√á√ÉO INLINE ===
      container.querySelectorAll(".comentario-acoes button[title='Editar']").forEach(btn => {
        btn.addEventListener("click", e => {
          const item = e.target.closest(".comentario-item");
          const id = item.dataset.id;
          const textoEl = item.querySelector(".comentario-texto");
          const antigoTexto = textoEl.textContent.trim();

          const textarea = document.createElement("textarea");
          textarea.value = antigoTexto;
          textarea.className = "comentario-editar-area";

          const salvarBtn = document.createElement("button");
          salvarBtn.textContent = "üíæ Salvar";
          salvarBtn.className = "comentario-salvar-btn";

          const cancelarBtn = document.createElement("button");
          cancelarBtn.textContent = "‚ùå Cancelar";
          cancelarBtn.className = "comentario-cancelar-btn";

          textoEl.innerHTML = "";
          textoEl.appendChild(textarea);
          textoEl.appendChild(salvarBtn);
          textoEl.appendChild(cancelarBtn);

          salvarBtn.addEventListener("click", async () => {
            const novoTexto = textarea.value.trim();
            if (novoTexto && novoTexto !== antigoTexto) {
              await atualizarComentario(id, novoTexto, capituloId);
            } else textoEl.textContent = antigoTexto;
          });

          cancelarBtn.addEventListener("click", () => textoEl.textContent = antigoTexto);
        });
      });

     // === EXCLUS√ÉO INLINE ===
container.querySelectorAll(".comentario-acoes button[title='Excluir']").forEach(btn => {
  btn.addEventListener("click", e => {
    const item = e.target.closest(".comentario-item");
    const id = item.dataset.id;
    const textoEl = item.querySelector(".comentario-texto");
    const antigoTexto = textoEl.textContent.trim();

    // cria confirma√ß√£o inline
    textoEl.innerHTML = `
      <p style="margin-bottom:10px;">Tem certeza que deseja excluir este coment√°rio?</p>
      <button class="comentario-salvar-btn">üóëÔ∏è Excluir</button>
      <button class="comentario-cancelar-btn">‚ùå Cancelar</button>
    `;

    const excluirBtn = textoEl.querySelector(".comentario-salvar-btn");
    const cancelarBtn = textoEl.querySelector(".comentario-cancelar-btn");

    excluirBtn.addEventListener("click", async () => {
      await fetch(`${API}/comentarios/${id}`, { method: "DELETE" });
      if (window.location.href.includes("capitulo.html")) {
        const capituloId = new URLSearchParams(window.location.search).get("id");
        carregarComentarios(capituloId);
      } else {
        const mangaId = new URLSearchParams(window.location.search).get("id");
        carregarComentarios(mangaId);
      }
    });

    cancelarBtn.addEventListener("click", () => {
      textoEl.textContent = antigoTexto;
    });
  });
});

    }

    async function atualizarComentario(id, novoTexto, capituloId) {
      await fetch(`${API}/comentarios/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ texto: novoTexto })
      });
      carregarComentarios(capituloId);
    }

    async function excluirComentario(id, capituloId) {
      await fetch(`${API}/comentarios/${id}`, { method: "DELETE" });
      carregarComentarios(capituloId);
    }

    document.getElementById("comentarioForm").addEventListener("submit", async e => {
      e.preventDefault();
      const capituloId = new URLSearchParams(window.location.search).get("id");
      const autor = localStorage.getItem("apelido") || "An√¥nimo";
      const texto = document.getElementById("comentarioTexto").value.trim();
      if (!texto) return;
      await fetch(`${API}/comentarios`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ autor, texto, capitulo: { id: Number(capituloId) } })
      });
      document.getElementById("comentarioTexto").value = "";
      carregarComentarios(capituloId);
    });

    document.addEventListener("DOMContentLoaded", carregarCapitulo);
  </script>
</body>
</html>
